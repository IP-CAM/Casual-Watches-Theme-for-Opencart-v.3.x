<?xml version="1.0" encoding="utf-8"?>
<modification>
    <name>Module positions</name>
    <version>1.0.0</version>
    <code>cw-module-positions</code>

    <!--
        Promo
        Depends on:
            - catalog/controller/common/content_promo.php
            - catalog/view/theme/{<Theme name>}/common/content_promo.twig
    -->
    <file path="admin/language/en-gb/design/layout.php">
        <operation>
            <search>
                <![CDATA[
$_['text_content_bottom']
                ]]>
            </search>
            <add position="before">
                <![CDATA[
$_['text_content_promo'] = 'Promo';
                ]]>
            </add>
        </operation>
    </file>

    <file path="admin/view/template/design/layout_form.twig">
        <operation>
            <search index="0">
                <![CDATA[
<table id="module-content-top" class="table table-striped table-bordered table-hover">
                ]]>
            </search>
            <add position="before"><![CDATA[
<table id="module-content-promo" class="table table-striped table-bordered table-hover">
  <thead>
    <tr>
      <td class="text-center">{{ text_content_promo }}</td>
    </tr>
  </thead>
  <tbody>
    {% for layout_module in layout_modules %}
    {% if layout_module.position == 'content_promo' %}
    <tr id="module-row{{ module_row }}">
      <td class="text-right"><div class="input-group">
          <select name="layout_module[{{ module_row }}][code]" class="form-control input-sm">
            {% for extension in extensions %}
            <optgroup label="{{ extension.name }}">
            {% if not extension.module %}
            {% if extension.code == layout_module.code %}
            <option value="{{ extension.code }}" selected="selected">{{ extension.name }}</option>
            {% else %}
            <option value="{{ extension.code }}">{{ extension.name }}</option>
            {% endif %}
            {% else %}
            {% for module in extension.module %}
            {% if module.code == layout_module.code %}
            <option value="{{ module.code }}" selected="selected">{{ module.name }}</option>
            {% else %}
            <option value="{{ module.code }}">{{ module.name }}</option>
            {% endif %}
            {% endfor %}
            {% endif %}
            </optgroup>
            {% endfor %}
          </select>
          <input type="hidden" name="layout_module[{{ module_row }}][position]" value="{{ layout_module.position }}" />
          <input type="hidden" name="layout_module[{{ module_row }}][sort_order]" value="{{ layout_module.sort_order }}" />
          <div class="input-group-btn"> <a href="{{ layout_module.edit }}" type="button" data-toggle="tooltip" title="{{ button_edit }}" target="_blank" class="btn btn-primary btn-sm"><i class="fa fa-pencil"></i></a>
            <button type="button" onclick="$('#module-row{{ module_row }}').remove();" data-toggle="tooltip" title="{{ button_remove }}" class="btn btn-danger btn-sm"><i class="fa fa fa-minus-circle"></i></button>
          </div>
        </div></td>
    </tr>
    {% set module_row = module_row + 1 %}
    {% endif %}
    {% endfor %}
  </tbody>
  <tfoot>
    <tr>
      <td class="text-left"><div class="input-group">
          <select class="form-control input-sm">
            <option value=""></option>
            {% for extension in extensions %}
            <optgroup label="{{ extension.name }}">
            {% if not extension.module %}
            <option value="{{ extension.code }}">{{ extension.name }}</option>
            {% else %}
            {% for module in extension.module %}
            <option value="{{ module.code }}">{{ module.name }}</option>
            {% endfor %}
            {% endif %}
            </optgroup>
            {% endfor %}
          </select>
          <div class="input-group-btn">
            <button type="button" onclick="addModule('content-promo');" data-toggle="tooltip" title="{{ button_module_add }}" class="btn btn-primary btn-sm"><i class="fa fa-plus-circle"></i></button>
          </div>
        </div></td>
    </tr>
  </tfoot>
</table>
                ]]>
            </add>
        </operation>
    </file>

    <file path="catalog/controller/common/home.php">
        <operation>
            <search index="0">
                <![CDATA[
$data['content_top'] = $this->load->controller('common/content_top');
                ]]>
            </search>
            <add position="before">
                <![CDATA[
$data['content_promo'] = $this->load->controller('common/content_promo');
                ]]>
            </add>
        </operation>
    </file>

    <!--
    Product discount
    -->
    <file path="catalog/controller/product/category.php">
        <operation>
            <search>
                <![CDATA[
$special = false;
                ]]>
            </search>
            <add position="after" offset="1">
                <![CDATA[
if ((float)$result['special']) {
    $discount = '-' . round(100 - $this->tax->calculate($result['special'], $result['tax_class_id'], $this->config->get('config_tax')) / $this->tax->calculate($result['price'], $result['tax_class_id'], $this->config->get('config_tax')) * 100) . '%';
} else {
    $discount = false;
}
                ]]>
            </add>
        </operation>

        <operation>
            <search>
                <![CDATA[
'special'     => $special,
                ]]>
            </search>
            <add position="after" offset="1">
                <![CDATA[
'discount'     => $discount,
                ]]>
            </add>
        </operation>
    </file>
</modification>
